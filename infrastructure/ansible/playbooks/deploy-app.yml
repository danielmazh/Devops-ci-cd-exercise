---
# =============================================================================
# DevOps Testing App - Application Deployment Playbook
# =============================================================================
# Deploys the application to the app server
# Usage: ansible-playbook playbooks/deploy-app.yml -i inventory/staging.ini \
#        -e "docker_tag=42-abc123"
# =============================================================================

- name: Deploy Application
  hosts: app
  become: yes
  gather_facts: yes

  vars:
    # Can be overridden with -e "docker_tag=xxx"
    docker_tag: "{{ lookup('env', 'IMAGE_TAG') | default('latest', true) }}"
    backup_enabled: true

  pre_tasks:
    - name: Display deployment info
      debug:
        msg: |
          ============================================
          Starting Deployment
          Image: {{ docker_image }}:{{ docker_tag }}
          Environment: {{ environment }}
          Target: {{ ansible_host }}
          ============================================

  tasks:
    # -------------------------------------------------------------------------
    # Pre-Deployment Backup
    # -------------------------------------------------------------------------
    - name: Get current running container info
      command: docker inspect devops-app-{{ environment }} --format '{{ '{{' }}.Config.Image{{ '}}' }}'
      register: current_image
      ignore_errors: yes
      changed_when: false
      when: backup_enabled

    - name: Save current image tag for rollback
      copy:
        content: "{{ current_image.stdout | default('none') }}"
        dest: "{{ app_install_dir }}/backup/previous-image.txt"
      when: 
        - backup_enabled
        - current_image is succeeded
        - current_image.stdout | length > 0

    # -------------------------------------------------------------------------
    # Pull New Image
    # -------------------------------------------------------------------------
    - name: Login to Docker Hub
      docker_login:
        username: "{{ docker_hub_username }}"
        password: "{{ docker_hub_token }}"
        registry_url: "https://index.docker.io/v1/"
      when: docker_hub_token | length > 0

    - name: Pull new application image
      docker_image:
        name: "{{ docker_image }}:{{ docker_tag }}"
        source: pull
        force_source: yes
      register: image_pull

    - name: Display pull result
      debug:
        msg: "Image {{ docker_image }}:{{ docker_tag }} pulled successfully"
      when: image_pull is succeeded

    # -------------------------------------------------------------------------
    # Update Docker Compose Configuration
    # -------------------------------------------------------------------------
    - name: Update docker-compose.yml with new tag
      template:
        src: ../roles/docker-app/templates/docker-compose.yml.j2
        dest: "{{ app_install_dir }}/docker-compose.yml"
        owner: ec2-user
        group: ec2-user
        mode: '0644'

    - name: Update .env file
      lineinfile:
        path: "{{ app_install_dir }}/.env"
        regexp: "^IMAGE_TAG="
        line: "IMAGE_TAG={{ docker_tag }}"

    # -------------------------------------------------------------------------
    # Deploy Application
    # -------------------------------------------------------------------------
    - name: Stop existing application
      community.docker.docker_compose_v2:
        project_src: "{{ app_install_dir }}"
        state: absent
      ignore_errors: yes

    - name: Start application with new image
      community.docker.docker_compose_v2:
        project_src: "{{ app_install_dir }}"
        state: present
        pull: never  # Already pulled above
      register: deploy_result

    # -------------------------------------------------------------------------
    # Health Check
    # -------------------------------------------------------------------------
    - name: Wait for application to be healthy
      uri:
        url: "http://localhost:{{ app_port }}/health"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 12
      delay: 5

    - name: Display health check result
      debug:
        msg: "Health check passed: {{ health_check.json }}"

    # -------------------------------------------------------------------------
    # Verify Deployment
    # -------------------------------------------------------------------------
    - name: Get running container info
      command: docker ps --filter "name=devops-app" --format "{{ '{{' }}.Image{{ '}}' }} - {{ '{{' }}.Status{{ '}}' }}"
      register: container_status
      changed_when: false

    - name: Display container status
      debug:
        msg: "Running container: {{ container_status.stdout }}"

  post_tasks:
    - name: Deployment complete
      debug:
        msg: |
          ============================================
          Deployment Successful!
          Image: {{ docker_image }}:{{ docker_tag }}
          URL: http://{{ ansible_host }}
          Health: http://{{ ansible_host }}/health
          Status: {{ health_check.json.status }}
          ============================================

    # -------------------------------------------------------------------------
    # Cleanup Old Images
    # -------------------------------------------------------------------------
    - name: Remove dangling images
      command: docker image prune -f
      changed_when: false
