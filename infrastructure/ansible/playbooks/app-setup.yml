---
# =============================================================================
# DevOps Testing App - App Server Setup Playbook (PRODUCTION READY)
# =============================================================================
# Prepares the application server with Docker and dependencies
# Usage: ansible-playbook playbooks/app-setup.yml -i inventory/staging.ini
# =============================================================================

- name: Setup Application Server
  hosts: app
  become: yes
  gather_facts: yes

  vars:
    app_install_dir: "/opt/devops-app"
    docker_hub_username: "{{ lookup('env', 'DOCKER_HUB_USERNAME') | default('danielmazh', true) }}"
    docker_hub_token: "{{ lookup('env', 'DOCKER_HUB_TOKEN') | default('', true) }}"
    docker_image: "danielmazh/devops-testing-app"
    docker_tag: "latest"
    app_port: 80
    app_container_port: 5000
    app_internal_port: 5000
    deploy_env: "staging"
    app_container_name: "devops-app"
    flask_env: "production"
    flask_secret_key: "devops-secret-key-2026"
    environment: "staging"

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

  tasks:
    # -------------------------------------------------------------------------
    # Install System Dependencies
    # -------------------------------------------------------------------------
    - name: Install required packages
      yum:
        name:
          - python3
          - python3-pip
          - git
          - jq
        state: present
      register: pkg_result
      retries: 3
      delay: 10
      until: pkg_result is succeeded
      # Note: curl is provided by curl-minimal on Amazon Linux 2023

    # -------------------------------------------------------------------------
    # Install Docker (if not already installed by cloud-init)
    # -------------------------------------------------------------------------
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker via Amazon Linux Extras
      shell: |
        amazon-linux-extras install docker -y
        systemctl start docker
        systemctl enable docker
        usermod -aG docker ec2-user
      when: docker_check.rc != 0
      register: docker_install

    - name: Verify Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Display Docker version
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Show Docker version
      debug:
        msg: "Docker version: {{ docker_version.stdout }}"

    # -------------------------------------------------------------------------
    # Install Docker Compose
    # -------------------------------------------------------------------------
    - name: Check if Docker Compose is installed
      command: docker compose version
      register: compose_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker Compose Plugin
      shell: |
        mkdir -p /usr/local/lib/docker/cli-plugins
        curl -SL "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64" -o /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
      when: compose_check.rc != 0
      register: compose_install

    - name: Verify Docker Compose installation
      command: docker compose version
      register: compose_version
      changed_when: false

    - name: Show Docker Compose version
      debug:
        msg: "Docker Compose version: {{ compose_version.stdout }}"

    # -------------------------------------------------------------------------
    # Create Application Directories
    # -------------------------------------------------------------------------
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: ec2-user
        group: ec2-user
        mode: '0755'
      loop:
        - "{{ app_install_dir }}"
        - "{{ app_install_dir }}/logs"
        - "{{ app_install_dir }}/backup"

    # -------------------------------------------------------------------------
    # Login to Docker Hub
    # -------------------------------------------------------------------------
    - name: Login to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_hub_username }}"
        password: "{{ docker_hub_token }}"
        registry_url: "https://index.docker.io/v1/"
      when: docker_hub_token | length > 0
      ignore_errors: yes

    # -------------------------------------------------------------------------
    # Create Docker Compose File
    # -------------------------------------------------------------------------
    - name: Create application docker-compose.yml
      template:
        src: ../roles/docker-app/templates/docker-compose.yml.j2
        dest: "{{ app_install_dir }}/docker-compose.yml"
        owner: ec2-user
        group: ec2-user
        mode: '0644'

    # -------------------------------------------------------------------------
    # Create Environment File
    # -------------------------------------------------------------------------
    - name: Create .env file
      copy:
        content: |
          # Application Environment
          ENVIRONMENT={{ environment }}
          DOCKER_IMAGE={{ docker_image }}
          IMAGE_TAG={{ docker_tag }}
          APP_PORT={{ app_port }}
          FLASK_ENV={{ flask_env }}
          SECRET_KEY={{ flask_secret_key }}
        dest: "{{ app_install_dir }}/.env"
        owner: ec2-user
        group: ec2-user
        mode: '0600'

    # -------------------------------------------------------------------------
    # Pull Application Image (optional - Jenkins will push it)
    # -------------------------------------------------------------------------
    - name: Pull application Docker image
      community.docker.docker_image:
        name: "{{ docker_image }}:{{ docker_tag }}"
        source: pull
      register: pull_result
      ignore_errors: yes

    - name: Display pull result
      debug:
        msg: "{{ 'Image pulled successfully' if pull_result is succeeded else 'Image not available yet - will be built by Jenkins' }}"

    # -------------------------------------------------------------------------
    # Setup Log Rotation
    # -------------------------------------------------------------------------
    - name: Configure Docker log rotation
      copy:
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "5"
            }
          }
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: '0644'
      notify: Restart Docker

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted

  post_tasks:
    - name: App server setup complete
      debug:
        msg: |
          ============================================
          App server setup completed!
          Host: {{ ansible_host }}
          App URL: http://{{ ansible_host }}
          Install Dir: {{ app_install_dir }}
          ============================================
