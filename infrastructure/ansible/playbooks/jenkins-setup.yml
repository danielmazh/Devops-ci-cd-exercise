---
# =============================================================================
# DevOps Testing App - Jenkins Setup Playbook (PRODUCTION READY)
# =============================================================================
# Installs and configures Jenkins on EC2 instance with all dependencies
# Usage: ansible-playbook playbooks/jenkins-setup.yml -i inventory/staging.ini
# =============================================================================

- name: Setup Jenkins Server
  hosts: jenkins
  become: yes
  gather_facts: yes
  
  vars:
    jenkins_home: "/opt/jenkins/data"
    jenkins_casc_dir: "/opt/jenkins/casc"
    # Explicit vars for templates (with defaults)
    github_username: "{{ lookup('env', 'GITHUB_USERNAME') | default('danielmazh', true) }}"
    github_repo: "{{ lookup('env', 'GITHUB_REPO') | default('devops-ci-cd-exercise', true) }}"
    environment: "staging"
    docker_hub_username: "{{ lookup('env', 'DOCKER_HUB_USERNAME') | default('danielmazh', true) }}"
    docker_hub_token: "{{ lookup('env', 'DOCKER_HUB_TOKEN') | default('', true) }}"
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') | default('', true) }}"
    jira_url: "{{ lookup('env', 'JIRA_URL') | default('https://danielmaz.atlassian.net', true) }}"
    jira_email: "{{ lookup('env', 'JIRA_EMAIL') | default('daniel.mazhbits@gmail.com', true) }}"
    jira_api_token: "{{ lookup('env', 'JIRA_API_TOKEN') | default('', true) }}"
    jira_project_key: "{{ lookup('env', 'JIRA_PROJECT_KEY') | default('CICD', true) }}"
    notification_email: "{{ lookup('env', 'NOTIFICATION_EMAIL') | default('daniel.mazhbits@gmail.com', true) }}"
    jenkins_admin_user: "{{ lookup('env', 'JENKINS_ADMIN_USER') | default('admin', true) }}"
    jenkins_admin_password: "{{ lookup('env', 'JENKINS_ADMIN_PASSWORD') | default('DevOps2026!', true) }}"
    jenkins_port: 8080
    jenkins_agent_port: 50000
    app_server_ip: "{{ hostvars['app-server']['ansible_host'] | default('') }}"
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"
    aws_region: "{{ lookup('env', 'AWS_DEFAULT_REGION') | default('us-east-1', true) }}"
    
  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

  tasks:
    # -------------------------------------------------------------------------
    # Install System Dependencies
    # -------------------------------------------------------------------------
    - name: Install required packages
      yum:
        name:
          - python3
          - python3-pip
          - git
          - jq
          - curl
          - wget
          - unzip
        state: present
      register: pkg_result
      retries: 3
      delay: 10
      until: pkg_result is succeeded

    # -------------------------------------------------------------------------
    # Install Docker (if not already installed by cloud-init)
    # -------------------------------------------------------------------------
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker via Amazon Linux Extras
      shell: |
        amazon-linux-extras install docker -y
        systemctl start docker
        systemctl enable docker
        usermod -aG docker ec2-user
      when: docker_check.rc != 0
      register: docker_install
      
    - name: Verify Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Display Docker version
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Show Docker version
      debug:
        msg: "Docker version: {{ docker_version.stdout }}"

    # -------------------------------------------------------------------------
    # Install Docker Compose
    # -------------------------------------------------------------------------
    - name: Check if Docker Compose is installed
      command: docker compose version
      register: compose_check
      ignore_errors: yes
      changed_when: false

    - name: Install Docker Compose Plugin
      shell: |
        mkdir -p /usr/local/lib/docker/cli-plugins
        curl -SL "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64" -o /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
      when: compose_check.rc != 0
      register: compose_install

    - name: Verify Docker Compose installation
      command: docker compose version
      register: compose_version
      changed_when: false

    - name: Show Docker Compose version
      debug:
        msg: "Docker Compose version: {{ compose_version.stdout }}"

    # -------------------------------------------------------------------------
    # Create Jenkins Directories
    # -------------------------------------------------------------------------
    - name: Create Jenkins directories
      file:
        path: "{{ item }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'
      loop:
        - "{{ jenkins_home }}"
        - "{{ jenkins_home }}/jobs"
        - "{{ jenkins_home }}/jobs/devops-testing-app"
        - "{{ jenkins_home }}/secrets"
        - "{{ jenkins_casc_dir }}"
        - "/opt/jenkins/backup"

    # -------------------------------------------------------------------------
    # Create Pipeline Job Config (before Jenkins starts)
    # -------------------------------------------------------------------------
    - name: Create Jenkins pipeline job config
      copy:
        dest: "{{ jenkins_home }}/jobs/devops-testing-app/config.xml"
        owner: 1000
        group: 1000
        mode: '0644'
        content: |
          <?xml version="1.1" encoding="UTF-8"?>
          <flow-definition plugin="workflow-job">
            <description>DevOps Testing App CI/CD Pipeline</description>
            <keepDependencies>false</keepDependencies>
            <definition class="org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition" plugin="workflow-cps">
              <scm class="hudson.plugins.git.GitSCM" plugin="git">
                <configVersion>2</configVersion>
                <userRemoteConfigs>
                  <hudson.plugins.git.UserRemoteConfig>
                    <url>https://github.com/{{ github_username }}/{{ github_repo }}.git</url>
                  </hudson.plugins.git.UserRemoteConfig>
                </userRemoteConfigs>
                <branches>
                  <hudson.plugins.git.BranchSpec>
                    <name>*/main</name>
                  </hudson.plugins.git.BranchSpec>
                </branches>
              </scm>
              <scriptPath>jenkins/Jenkinsfile</scriptPath>
              <lightweight>true</lightweight>
            </definition>
            <disabled>false</disabled>
          </flow-definition>

    # -------------------------------------------------------------------------
    # Create Docker Credentials Files
    # -------------------------------------------------------------------------
    - name: Create Docker username secret file
      copy:
        dest: "{{ jenkins_home }}/secrets/docker-username"
        owner: 1000
        group: 1000
        mode: '0600'
        content: "{{ docker_hub_username }}"

    - name: Create Docker password secret file
      copy:
        dest: "{{ jenkins_home }}/secrets/docker-password"
        owner: 1000
        group: 1000
        mode: '0600'
        content: "{{ docker_hub_token }}"
      when: docker_hub_token | length > 0

    # -------------------------------------------------------------------------
    # Copy Jenkins Configuration as Code
    # -------------------------------------------------------------------------
    - name: Create Jenkins CasC configuration
      template:
        src: ../roles/jenkins/templates/jenkins-casc.yaml.j2
        dest: "{{ jenkins_casc_dir }}/jenkins.yaml"
        owner: 1000
        group: 1000
        mode: '0644'
      notify: Restart Jenkins

    # -------------------------------------------------------------------------
    # Copy Plugins List
    # -------------------------------------------------------------------------
    - name: Copy Jenkins plugins list
      copy:
        src: ../roles/jenkins/files/plugins.txt
        dest: "/opt/jenkins/plugins.txt"
        owner: 1000
        group: 1000
        mode: '0644'

    # -------------------------------------------------------------------------
    # Create Docker Compose File
    # -------------------------------------------------------------------------
    - name: Create Jenkins docker-compose.yml
      template:
        src: ../roles/jenkins/templates/docker-compose.yml.j2
        dest: "/opt/jenkins/docker-compose.yml"
        owner: root
        group: root
        mode: '0644'
      notify: Restart Jenkins

    # -------------------------------------------------------------------------
    # Login to Docker Hub
    # -------------------------------------------------------------------------
    - name: Login to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_hub_username }}"
        password: "{{ docker_hub_token }}"
        registry_url: "https://index.docker.io/v1/"
      when: docker_hub_token | length > 0
      ignore_errors: yes

    # -------------------------------------------------------------------------
    # Start Jenkins Container
    # -------------------------------------------------------------------------
    - name: Pull Jenkins image
      community.docker.docker_image:
        name: jenkins/jenkins:lts-jdk17
        source: pull
      retries: 3
      delay: 10

    - name: Start Jenkins with Docker Compose
      community.docker.docker_compose_v2:
        project_src: /opt/jenkins
        state: present
      register: jenkins_compose_result

    - name: Display Jenkins compose result
      debug:
        var: jenkins_compose_result

    # -------------------------------------------------------------------------
    # Wait for Jenkins to be Ready
    # -------------------------------------------------------------------------
    - name: Wait for Jenkins to start (up to 5 minutes)
      uri:
        url: "http://localhost:8080/login"
        method: GET
        status_code: 200
      register: jenkins_health
      until: jenkins_health.status == 200
      retries: 30
      delay: 10

    # -------------------------------------------------------------------------
    # Install Tools in Jenkins Container
    # -------------------------------------------------------------------------
    - name: Install Python and tools in Jenkins container
      command: >
        docker exec -u root jenkins bash -c 
        "apt-get update && 
         apt-get install -y python3 python3-pip python3-venv git curl jq &&
         ln -sf /usr/bin/python3 /usr/bin/python || true"
      register: python_install
      changed_when: "'Setting up python3' in python_install.stdout"
      ignore_errors: yes
      retries: 2
      delay: 5

    - name: Install Docker CLI in Jenkins container
      command: >
        docker exec -u root jenkins bash -c 
        "apt-get install -y docker.io && 
         usermod -aG docker jenkins && 
         chmod 666 /var/run/docker.sock"
      register: docker_cli_install
      changed_when: "'Setting up docker' in docker_cli_install.stdout"
      ignore_errors: yes
      retries: 2
      delay: 5

    - name: Verify Python installation in Jenkins
      command: docker exec jenkins python3 --version
      register: python_version_jenkins
      changed_when: false
      ignore_errors: yes

    - name: Verify Docker access in Jenkins
      command: docker exec jenkins docker --version
      register: docker_version_jenkins
      changed_when: false
      ignore_errors: yes

    - name: Display tool versions
      debug:
        msg: |
          Python in Jenkins: {{ python_version_jenkins.stdout | default('Not installed') }}
          Docker in Jenkins: {{ docker_version_jenkins.stdout | default('Not installed') }}

    # -------------------------------------------------------------------------
    # Display Jenkins Credentials
    # -------------------------------------------------------------------------
    - name: Display Jenkins credentials
      debug:
        msg: |
          ============================================
          Jenkins is ready!
          URL: http://{{ ansible_host }}:8080
          User: {{ jenkins_admin_user }}
          Password: {{ jenkins_admin_password }}
          ============================================

  handlers:
    - name: Restart Jenkins
      community.docker.docker_compose_v2:
        project_src: /opt/jenkins
        state: restarted

  post_tasks:
    - name: Jenkins setup complete
      debug:
        msg: "Jenkins setup completed successfully on {{ ansible_host }}"
