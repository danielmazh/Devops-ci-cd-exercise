# =============================================================================
# DevOps Testing App - Application Docker Compose - Generated by Ansible
# =============================================================================
version: "{{ docker_compose_version | default('3.9') }}"

services:
  app:
    image: {{ docker_image }}:{{ docker_tag | default('latest') }}
    container_name: {{ app_container_name | default('devops-app') }}
    restart: always
    ports:
      - "{{ app_port | default(80) }}:{{ app_internal_port | default(5000) }}"
    environment:
      - FLASK_ENV={{ flask_env | default('production') }}
      - SECRET_KEY={{ flask_secret_key | default('change-me') }}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ app_internal_port | default(5000) }}{{ health_check_endpoint | default('/health') }}"]
      interval: {{ health_check_interval | default(30) }}s
      timeout: {{ health_check_timeout | default(10) }}s
      retries: {{ health_check_retries | default(3) }}
      start_period: {{ health_check_start_period | default(30) }}s
    deploy:
      resources:
        limits:
          cpus: '{{ app_cpu_limit | default("1.0") }}'
          memory: {{ app_memory_limit | default("512M") }}
        reservations:
          cpus: '{{ app_cpu_reservation | default("0.25") }}'
          memory: {{ app_memory_reservation | default("128M") }}
    logging:
      driver: "{{ log_driver | default('json-file') }}"
      options:
        max-size: "{{ log_max_size | default('10m') }}"
        max-file: "{{ log_max_file | default('5') }}"
    networks:
      - app-network
    labels:
      - "com.devops.service=app"
      - "com.devops.environment={{ deploy_env | default('staging') }}"
      - "com.devops.version={{ docker_tag | default('latest') }}"

networks:
  app-network:
    driver: bridge
    name: devops-app-network
