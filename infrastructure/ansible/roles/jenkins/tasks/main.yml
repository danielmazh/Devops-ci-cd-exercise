---
# =============================================================================
# DevOps Testing App - Jenkins Role Tasks
# =============================================================================

# -----------------------------------------------------------------------------
# Directory Setup
# -----------------------------------------------------------------------------
- name: Ensure Jenkins directories exist
  file:
    path: "{{ item }}"
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'
  loop:
    - "{{ jenkins_home }}"
    - "{{ jenkins_home }}/jobs/devops-testing-app"
    - "{{ jenkins_home }}/secrets"
    - "{{ jenkins_casc_dir }}"
    - "/opt/jenkins/backup"

# -----------------------------------------------------------------------------
# Configuration Files
# -----------------------------------------------------------------------------
- name: Copy Jenkins CasC configuration
  template:
    src: jenkins-casc.yaml.j2
    dest: "{{ jenkins_casc_dir }}/jenkins.yaml"
    owner: 1000
    group: 1000
    mode: '0644'
  notify: Restart Jenkins container

- name: Copy Jenkins plugins list
  copy:
    src: plugins.txt
    dest: "/opt/jenkins/plugins.txt"
    owner: 1000
    group: 1000
    mode: '0644'

- name: Create Jenkins docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: "/opt/jenkins/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  notify: Restart Jenkins container

# -----------------------------------------------------------------------------
# Create Pipeline Job Config
# -----------------------------------------------------------------------------
- name: Create Jenkins pipeline job config
  copy:
    dest: "{{ jenkins_home }}/jobs/devops-testing-app/config.xml"
    owner: 1000
    group: 1000
    mode: '0644'
    content: |
      <?xml version="1.1" encoding="UTF-8"?>
      <flow-definition plugin="workflow-job">
        <description>DevOps Testing App CI/CD Pipeline</description>
        <keepDependencies>false</keepDependencies>
        <definition class="org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition" plugin="workflow-cps">
          <scm class="hudson.plugins.git.GitSCM" plugin="git">
            <configVersion>2</configVersion>
            <userRemoteConfigs>
              <hudson.plugins.git.UserRemoteConfig>
                <url>https://github.com/{{ github_username }}/{{ github_repo }}.git</url>
              </hudson.plugins.git.UserRemoteConfig>
            </userRemoteConfigs>
            <branches>
              <hudson.plugins.git.BranchSpec>
                <name>*/main</name>
              </hudson.plugins.git.BranchSpec>
            </branches>
          </scm>
          <scriptPath>jenkins/Jenkinsfile</scriptPath>
          <lightweight>true</lightweight>
        </definition>
        <disabled>false</disabled>
      </flow-definition>

# -----------------------------------------------------------------------------
# Create Docker Credentials Files
# -----------------------------------------------------------------------------
- name: Create Docker username secret file
  copy:
    dest: "{{ jenkins_home }}/secrets/docker-username"
    owner: 1000
    group: 1000
    mode: '0600'
    content: "{{ docker_hub_username }}"

- name: Create Docker password secret file
  copy:
    dest: "{{ jenkins_home }}/secrets/docker-password"
    owner: 1000
    group: 1000
    mode: '0600'
    content: "{{ docker_hub_token }}"

# -----------------------------------------------------------------------------
# Start Jenkins Container
# -----------------------------------------------------------------------------
- name: Start Jenkins container
  community.docker.docker_compose_v2:
    project_src: /opt/jenkins
    state: present
  register: jenkins_output

- name: Wait for Jenkins container to be running
  pause:
    seconds: 30

# -----------------------------------------------------------------------------
# Install Tools in Jenkins Container
# -----------------------------------------------------------------------------
- name: Install Python in Jenkins container
  command: >
    docker exec -u root jenkins bash -c 
    "apt-get update && apt-get install -y python3 python3-pip python3-venv && ln -sf /usr/bin/python3 /usr/bin/python || true"
  register: python_install
  changed_when: "'Setting up python3' in python_install.stdout"
  ignore_errors: yes

- name: Install Docker CLI in Jenkins container
  command: >
    docker exec -u root jenkins bash -c 
    "apt-get install -y docker.io && usermod -aG docker jenkins && chmod 666 /var/run/docker.sock"
  register: docker_install
  changed_when: "'Setting up docker' in docker_install.stdout"
  ignore_errors: yes

# -----------------------------------------------------------------------------
# Install Browser Dependencies for E2E Tests
# -----------------------------------------------------------------------------
- name: Install Firefox and Xvfb for E2E tests
  command: >
    docker exec -u root jenkins bash -c 
    "apt-get update && apt-get install -y firefox-esr xvfb libgtk-3-0 libdbus-glib-1-2 libxt6 libx11-xcb1"
  register: firefox_install
  changed_when: "'Setting up firefox' in firefox_install.stdout"
  ignore_errors: yes

- name: Install GeckoDriver for Selenium
  command: >
    docker exec -u root jenkins bash -c 
    "wget -q https://github.com/mozilla/geckodriver/releases/download/v0.34.0/geckodriver-v0.34.0-linux64.tar.gz -O /tmp/geckodriver.tar.gz &&
     tar -xzf /tmp/geckodriver.tar.gz -C /usr/local/bin &&
     chmod +x /usr/local/bin/geckodriver &&
     rm /tmp/geckodriver.tar.gz"
  register: geckodriver_install
  changed_when: geckodriver_install.rc == 0
  ignore_errors: yes

# -----------------------------------------------------------------------------
# Wait for Jenkins to be Ready
# -----------------------------------------------------------------------------
- name: Wait for Jenkins to be ready
  uri:
    url: "http://localhost:{{ jenkins_port }}/login"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 10

# -----------------------------------------------------------------------------
# Install Jenkins Plugins
# -----------------------------------------------------------------------------
- name: Install Jenkins plugins via jenkins-plugin-cli
  command: >
    docker exec jenkins jenkins-plugin-cli --plugins
    structs workflow-step-api workflow-api workflow-support scm-api workflow-scm-step
    workflow-job workflow-cps workflow-aggregator pipeline-model-definition
    pipeline-model-api pipeline-model-extensions pipeline-groovy-lib pipeline-stage-view
    pipeline-utility-steps git git-client github docker-workflow credentials-binding
    junit htmlpublisher email-ext configuration-as-code job-dsl ws-cleanup
    timestamper ansicolor http_request ssh-agent ssh-credentials
  register: plugin_install
  changed_when: "'Done' in plugin_install.stdout or plugin_install.rc == 0"
  retries: 2
  delay: 10

- name: Restart Jenkins to load plugins
  command: docker restart jenkins
  when: plugin_install.changed

- name: Wait for Jenkins after plugin restart
  uri:
    url: "http://localhost:{{ jenkins_port }}/login"
    status_code: 200
  register: result_after_plugins
  until: result_after_plugins.status == 200
  retries: 30
  delay: 10
  when: plugin_install.changed
