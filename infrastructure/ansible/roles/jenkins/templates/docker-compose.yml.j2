# =============================================================================
# Jenkins Docker Compose - Generated by Ansible
# =============================================================================
# Note: 'version' is deprecated in Docker Compose V2+

services:
  jenkins:
    image: {{ jenkins_docker_image | default('jenkins/jenkins:lts-jdk17') }}
    container_name: {{ jenkins_container_name | default('jenkins') }}
    restart: unless-stopped
    privileged: true
    user: root
    ports:
      - "{{ jenkins_port | default(8080) }}:8080"
      - "{{ jenkins_agent_port | default(50000) }}:50000"
    environment:
      - JAVA_OPTS={{ jenkins_java_opts | default('-Djenkins.install.runSetupWizard=false -Dhudson.model.DownloadService.noSignatureCheck=true') }}
      - CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs
      # Docker Hub credentials
      - DOCKER_HUB_USERNAME={{ docker_hub_username }}
      - DOCKER_HUB_TOKEN={{ docker_hub_token }}
      # GitHub credentials
      - GITHUB_USERNAME={{ github_username }}
      - GITHUB_TOKEN={{ github_token | default('') }}
      # AWS credentials
      - AWS_ACCESS_KEY_ID={{ aws_access_key | default('') }}
      - AWS_SECRET_ACCESS_KEY={{ aws_secret_key | default('') }}
      - AWS_DEFAULT_REGION={{ aws_region | default('us-east-1') }}
      # JIRA credentials
      - JIRA_URL={{ jira_url }}
      - JIRA_EMAIL={{ jira_email }}
      - JIRA_API_TOKEN={{ jira_api_token | default('') }}
      - JIRA_PROJECT_KEY={{ jira_project_key | default('CICD') }}
      # Jenkins credentials
      - JENKINS_ADMIN_ID={{ jenkins_admin_user | default('admin') }}
      - JENKINS_ADMIN_PASSWORD={{ jenkins_admin_password | default('admin') }}
      - JENKINS_URL=http://{{ ansible_host }}:{{ jenkins_port | default(8080) }}/
      # App server info
      - APP_SERVER_IP={{ app_server_ip | default('') }}
      - NOTIFICATION_EMAIL={{ notification_email }}
    volumes:
      - {{ jenkins_home | default('/opt/jenkins/data') }}:/var/jenkins_home
      - {{ jenkins_casc_dir | default('/opt/jenkins/casc') }}:/var/jenkins_home/casc_configs:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/local/bin/docker:/usr/local/bin/docker:ro
      - /opt/jenkins/plugins.txt:/usr/share/jenkins/ref/plugins.txt:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    networks:
      - jenkins-network

networks:
  jenkins-network:
    driver: bridge
    name: jenkins-network
