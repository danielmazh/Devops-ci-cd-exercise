// =============================================================================
// DevOps Testing App - Enhanced Jenkins Pipeline
// =============================================================================
// Features:
// - All tests (unit, integration, e2e) - mandatory
// - Performance tests - production only
// - Code coverage reports to htmlcov/
// - Docker build & push to Docker Hub
// - JIRA issue creation on failure
// - Email notifications
// - AWS deployment via Ansible
// =============================================================================

pipeline {
    agent any
    
    parameters {
        booleanParam(name: 'RUN_PERFORMANCE_TESTS', defaultValue: true, description: 'Run performance tests (Locust load testing)')
        booleanParam(name: 'RUN_E2E_TESTS', defaultValue: true, description: 'Run E2E tests (Selenium + Firefox headless)')
        booleanParam(name: 'DEPLOY_TO_STAGING', defaultValue: false, description: 'Deploy to staging environment')
        booleanParam(name: 'DEPLOY_TO_PRODUCTION', defaultValue: false, description: 'Deploy to production environment')
        booleanParam(name: 'CREATE_JIRA_ON_SUCCESS', defaultValue: false, description: 'Create JIRA ticket on successful build with build summary')
    }
    
    environment {
        // Python
        PYTHON_VERSION = '3.9'
        VENV_DIR = 'venv'
        
        // Docker
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE = "${DOCKER_HUB_USERNAME}/devops-testing-app"
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        
        // Git
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
        VERSION_TAG = "${BUILD_NUMBER}-${GIT_COMMIT_SHORT}"
        
        // JIRA
        JIRA_SITE = 'jira-site'
        JIRA_PROJECT_KEY = 'CICD'
        
        // Notification
        NOTIFICATION_EMAIL = 'daniel.mazhbits@gmail.com'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds()
        ansiColor('xterm')
    }
    
    stages {
        // =====================================================================
        // Stage 1: Setup Environment
        // =====================================================================
        stage('Setup Environment') {
            steps {
                script {
                    echo "=========================================="
                    echo "Setting up Python ${PYTHON_VERSION} environment"
                    echo "=========================================="
                    
                    sh """
                        python${PYTHON_VERSION} -m venv ${VENV_DIR} || python3 -m venv ${VENV_DIR}
                        . ${VENV_DIR}/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                        pip install flake8 pylint bandit pytest-html
                    """
                }
            }
        }
        
        // =====================================================================
        // Stage 2: Code Quality (Parallel)
        // =====================================================================
        stage('Code Quality') {
            parallel {
                stage('Flake8') {
                    steps {
                        sh """
                            mkdir -p reports
                            . ${VENV_DIR}/bin/activate
                            flake8 app/ --max-line-length=120 --output-file=reports/flake8.txt || true
                        """
                    }
                }
                stage('Pylint') {
                    steps {
                        sh """
                            mkdir -p reports
                            . ${VENV_DIR}/bin/activate
                            pylint app/ --exit-zero --output=reports/pylint.txt || true
                        """
                    }
                }
                stage('Bandit Security') {
                    steps {
                        sh """
                            mkdir -p reports
                            . ${VENV_DIR}/bin/activate
                            bandit -r app/ -f json -o reports/bandit-report.json || true
                        """
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.txt,reports/*.json', allowEmptyArchive: true
                }
            }
        }
        
        // =====================================================================
        // Stage 3: Unit Tests (MANDATORY)
        // =====================================================================
        stage('Unit Tests') {
            steps {
                sh """
                    mkdir -p reports htmlcov
                    . ${VENV_DIR}/bin/activate
                    
                    pytest tests/unit/ tests/test_calc.py -v \\
                        --cov=app \\
                        --cov-report=xml:reports/coverage.xml \\
                        --cov-report=html:htmlcov \\
                        --cov-report=term-missing \\
                        --junit-xml=reports/unit-tests.xml \\
                        --html=reports/unit-tests.html \\
                        --self-contained-html
                """
            }
            post {
                always {
                    junit 'reports/unit-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Code Coverage Report'
                    ])
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'unit-tests.html',
                        reportName: 'Unit Test Report'
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: true
                }
            }
        }
        
        // =====================================================================
        // Stage 4: Integration Tests (MANDATORY)
        // =====================================================================
        stage('Integration Tests') {
            steps {
                sh """
                    . ${VENV_DIR}/bin/activate
                    
                    pytest tests/integration/ -v \\
                        --junit-xml=reports/integration-tests.xml \\
                        --html=reports/integration-tests.html \\
                        --self-contained-html
                """
            }
            post {
                always {
                    junit 'reports/integration-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'integration-tests.html',
                        reportName: 'Integration Test Report'
                    ])
                }
            }
        }
        
        // =====================================================================
        // Stage 5: E2E Tests (Selenium + Firefox Headless)
        // =====================================================================
        stage('E2E Tests') {
            when {
                expression { return params.RUN_E2E_TESTS == true }
            }
            steps {
                sh """
                    . ${VENV_DIR}/bin/activate
                    export DISPLAY=:99
                    
                    # Start virtual display for Firefox
                    Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
                    XVFB_PID=\$!
                    sleep 3
                    
                    # Verify Firefox is available
                    echo "Firefox version:"
                    firefox --version || echo "Firefox not found, tests may fail"
                    
                    # Run E2E tests with headless Firefox
                    pytest tests/e2e/ -v \\
                        --junit-xml=reports/e2e-tests.xml \\
                        --html=reports/e2e-tests.html \\
                        --self-contained-html
                    
                    # Cleanup
                    kill \$XVFB_PID 2>/dev/null || true
                """
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'reports/e2e-tests.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'e2e-tests.html',
                        reportName: 'E2E Test Report'
                    ])
                }
            }
        }
        
        // =====================================================================
        // Stage 6: Performance Tests (Locust Load Testing)
        // =====================================================================
        stage('Performance Tests') {
            when {
                expression { return params.RUN_PERFORMANCE_TESTS == true }
            }
            steps {
                sh """
                    . ${VENV_DIR}/bin/activate
                    
                    echo "=========================================="
                    echo "Starting Performance Tests with Locust"
                    echo "=========================================="
                    
                    # Start application in background
                    python main.py &
                    APP_PID=\$!
                    echo "Started app with PID: \$APP_PID"
                    
                    # Wait for app to be ready
                    sleep 5
                    curl -sf http://localhost:5000/health || echo "Health check warning"
                    
                    # Run Locust performance tests (headless mode)
                    locust -f tests/performance/locustfile.py \\
                        --headless \\
                        --users 10 \\
                        --spawn-rate 2 \\
                        --run-time 30s \\
                        --host http://localhost:5000 \\
                        --html reports/performance-report.html \\
                        --csv reports/performance
                    
                    LOCUST_EXIT=\$?
                    
                    # Cleanup - kill the app
                    kill \$APP_PID 2>/dev/null || true
                    
                    echo "Performance tests completed with exit code: \$LOCUST_EXIT"
                    exit \$LOCUST_EXIT
                """
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'performance-report.html',
                        reportName: 'Performance Test Report'
                    ])
                    archiveArtifacts artifacts: 'reports/performance*.csv', allowEmptyArchive: true
                }
            }
        }
        
        // =====================================================================
        // Stage 7: Build Docker Image
        // =====================================================================
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image: ${DOCKER_IMAGE}:${VERSION_TAG}"
                    
                    sh """
                        docker build \\
                            -f docker/Dockerfile \\
                            -t ${DOCKER_IMAGE}:${VERSION_TAG} \\
                            -t ${DOCKER_IMAGE}:latest \\
                            --build-arg BUILD_DATE="\$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \\
                            --build-arg VERSION="${VERSION_TAG}" \\
                            --build-arg GIT_COMMIT="${GIT_COMMIT_SHORT}" \\
                            .
                    """
                }
            }
        }
        
        // =====================================================================
        // Stage 8: Push to Docker Hub
        // =====================================================================
        stage('Push to Docker Hub') {
            steps {
                script {
                    sh """
                        # Read credentials from secrets files
                        DOCKER_USER=\$(cat /var/jenkins_home/secrets/docker-username 2>/dev/null || echo '')
                        DOCKER_PASS=\$(cat /var/jenkins_home/secrets/docker-password 2>/dev/null || echo '')
                        
                        if [ -n "\$DOCKER_USER" ] && [ -n "\$DOCKER_PASS" ]; then
                            echo "\$DOCKER_PASS" | docker login -u "\$DOCKER_USER" --password-stdin
                            docker push ${DOCKER_IMAGE}:${VERSION_TAG}
                            docker push ${DOCKER_IMAGE}:latest
                            docker logout
                        else
                            echo "Docker credentials not found, skipping push"
                            exit 1
                        fi
                    """
                    
                    echo "‚úÖ Pushed ${DOCKER_IMAGE}:${VERSION_TAG} to Docker Hub"
                }
            }
        }
        
        // =====================================================================
        // Stage 9: Deploy to Staging (AWS)
        // =====================================================================
        stage('Deploy to Staging') {
            when {
                expression { return params.DEPLOY_TO_STAGING == true }
            }
            steps {
                script {
                    echo "Deploying to AWS Staging..."
                    
                    withCredentials([
                        sshUserPrivateKey(
                            credentialsId: 'aws-ssh-key',
                            keyFileVariable: 'SSH_KEY'
                        ),
                        usernamePassword(
                            credentialsId: 'docker-hub-credentials',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_TOKEN'
                        )
                    ]) {
                        // Deploy directly to app server via SSH (no Ansible needed)
                        def appServerIp = sh(script: 'grep "app-server" infrastructure/ansible/inventory/staging.ini | grep -oP "ansible_host=\\K[0-9.]+"', returnStdout: true).trim()
                        
                        if (appServerIp) {
                            sh """
                                ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ec2-user@${appServerIp} << 'DEPLOY_EOF'
                                    set -e
                                    echo "Pulling and deploying Docker image..."
                                    
                                    # Login to Docker Hub
                                    echo "\${DOCKER_TOKEN}" | docker login -u "\${DOCKER_USER}" --password-stdin
                                    
                                    # Pull the new image
                                    docker pull ${DOCKER_IMAGE}:${VERSION_TAG}
                                    docker tag ${DOCKER_IMAGE}:${VERSION_TAG} ${DOCKER_IMAGE}:latest
                                    
                                    # Restart the app container
                                    cd /opt/devops-app
                                    docker compose down || true
                                    docker compose up -d
                                    
                                    # Verify deployment
                                    sleep 10
                                    curl -f http://localhost:5000/health || echo "Health check pending..."
                                    
                                    echo "Deployment complete!"
DEPLOY_EOF
                            """
                        } else {
                            error "Could not find app server IP in inventory"
                        }
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Staging deployment successful!"
                }
            }
        }
        
        // =====================================================================
        // Stage 10: Deploy to Production (Manual Approval)
        // =====================================================================
        stage('Deploy to Production') {
            when {
                expression { return params.DEPLOY_TO_PRODUCTION == true }
            }
            steps {
                // Manual approval gate
                input message: 'Deploy to Production?', ok: 'Deploy'
                
                script {
                    echo "Deploying to AWS Production..."
                    
                    // Note: In this demo, production uses the same app server as staging
                    // In real scenarios, you'd have separate production infrastructure
                    withCredentials([
                        sshUserPrivateKey(
                            credentialsId: 'aws-ssh-key',
                            keyFileVariable: 'SSH_KEY'
                        ),
                        usernamePassword(
                            credentialsId: 'docker-hub-credentials',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_TOKEN'
                        )
                    ]) {
                        // Deploy directly to app server via SSH
                        def appServerIp = sh(script: 'grep "app-server" infrastructure/ansible/inventory/staging.ini | grep -oP "ansible_host=\\K[0-9.]+"', returnStdout: true).trim()
                        
                        if (appServerIp) {
                            sh """
                                ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ec2-user@${appServerIp} << 'DEPLOY_EOF'
                                    set -e
                                    echo "Production deployment - Pulling and deploying Docker image..."
                                    
                                    # Login to Docker Hub
                                    echo "\${DOCKER_TOKEN}" | docker login -u "\${DOCKER_USER}" --password-stdin
                                    
                                    # Pull the specific version tag for production
                                    docker pull ${DOCKER_IMAGE}:${VERSION_TAG}
                                    docker tag ${DOCKER_IMAGE}:${VERSION_TAG} ${DOCKER_IMAGE}:production
                                    
                                    # Restart the app container
                                    cd /opt/devops-app
                                    docker compose down || true
                                    docker compose up -d
                                    
                                    # Verify deployment
                                    sleep 15
                                    curl -f http://localhost:5000/health && echo "Production deployment verified!"
                                    
                                    echo "Production deployment complete!"
DEPLOY_EOF
                            """
                        } else {
                            error "Could not find app server IP in inventory"
                        }
                    }
                }
            }
            post {
                success {
                    echo "üöÄ Production deployment successful!"
                }
            }
        }
    }
    
    // =========================================================================
    // Post Actions
    // =========================================================================
    post {
        always {
            // Archive all reports
            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
            archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: true
            
            // Cleanup
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true
            )
        }
        
        success {
            script {
                echo "‚úÖ Pipeline completed successfully!"
                
                // Create JIRA Issue on success if checkbox is checked
                def jiraIssueKey = null
                if (params.CREATE_JIRA_ON_SUCCESS == true) {
                    jiraIssueKey = createJiraSuccessIssue()
                }
                
                // Email notification
                emailext(
                    subject: "‚úÖ Build SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        <h2 style="color: green;">Build Successful!</h2>
                        <table border="1" cellpadding="5" style="border-collapse: collapse;">
                            <tr><td><strong>Job</strong></td><td>${env.JOB_NAME}</td></tr>
                            <tr><td><strong>Build</strong></td><td>#${env.BUILD_NUMBER}</td></tr>
                            <tr><td><strong>Branch</strong></td><td>${env.BRANCH_NAME ?: 'N/A'}</td></tr>
                            <tr><td><strong>Version</strong></td><td>${VERSION_TAG}</td></tr>
                            <tr><td><strong>Duration</strong></td><td>${currentBuild.durationString}</td></tr>
                            ${jiraIssueKey ? "<tr><td><strong>JIRA Issue</strong></td><td><a href='https://danielmaz.atlassian.net/browse/${jiraIssueKey}'>${jiraIssueKey}</a></td></tr>" : ''}
                        </table>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                        <p><a href="${env.BUILD_URL}Code_20Coverage_20Report/">View Coverage Report</a></p>
                    """,
                    to: NOTIFICATION_EMAIL,
                    mimeType: 'text/html'
                )
            }
        }
        
        failure {
            script {
                echo "‚ùå Pipeline failed!"
                
                // Create JIRA Issue
                def jiraIssueKey = createJiraIssue()
                
                // Email notification with JIRA link
                emailext(
                    subject: "‚ùå Build FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        <h2 style="color: red;">Build Failed!</h2>
                        <table border="1" cellpadding="5" style="border-collapse: collapse;">
                            <tr><td><strong>Job</strong></td><td>${env.JOB_NAME}</td></tr>
                            <tr><td><strong>Build</strong></td><td>#${env.BUILD_NUMBER}</td></tr>
                            <tr><td><strong>Branch</strong></td><td>${env.BRANCH_NAME ?: 'N/A'}</td></tr>
                            <tr><td><strong>Duration</strong></td><td>${currentBuild.durationString}</td></tr>
                            <tr><td><strong>Failed Stage</strong></td><td>${env.STAGE_NAME ?: 'Unknown'}</td></tr>
                            ${jiraIssueKey ? "<tr><td><strong>JIRA Issue</strong></td><td><a href='https://danielmaz.atlassian.net/browse/${jiraIssueKey}'>${jiraIssueKey}</a></td></tr>" : ''}
                        </table>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                        <p><a href="${env.BUILD_URL}console">View Console Log</a></p>
                    """,
                    to: NOTIFICATION_EMAIL,
                    mimeType: 'text/html'
                )
            }
        }
        
        unstable {
            echo "‚ö†Ô∏è Build is unstable. Check test results."
        }
    }
}

// =============================================================================
// Helper Functions
// =============================================================================

def createJiraIssue() {
    try {
        withCredentials([usernamePassword(
            credentialsId: 'jira-credentials',
            usernameVariable: 'JIRA_USER',
            passwordVariable: 'JIRA_TOKEN'
        )]) {
            def summary = "Build Failure: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            
            // JIRA API v3 requires ADF (Atlassian Document Format) for description
            def payload = [
                fields: [
                    project: [key: JIRA_PROJECT_KEY],
                    summary: summary,
                    description: [
                        type: "doc",
                        version: 1,
                        content: [
                            [
                                type: "heading",
                                attrs: [level: 2],
                                content: [[type: "text", text: "Build Failure Details"]]
                            ],
                            [
                                type: "paragraph",
                                content: [
                                    [type: "text", text: "Job: ", marks: [[type: "strong"]]],
                                    [type: "text", text: env.JOB_NAME]
                                ]
                            ],
                            [
                                type: "paragraph",
                                content: [
                                    [type: "text", text: "Build: ", marks: [[type: "strong"]]],
                                    [type: "text", text: "#${env.BUILD_NUMBER}"]
                                ]
                            ],
                            [
                                type: "paragraph",
                                content: [
                                    [type: "text", text: "Duration: ", marks: [[type: "strong"]]],
                                    [type: "text", text: currentBuild.durationString ?: "N/A"]
                                ]
                            ],
                            [
                                type: "paragraph",
                                content: [
                                    [type: "text", text: "Build URL: ", marks: [[type: "strong"]]],
                                    [type: "text", text: env.BUILD_URL, marks: [[type: "link", attrs: [href: env.BUILD_URL]]]]
                                ]
                            ]
                        ]
                    ],
                    issuetype: [name: "Bug"],
                    priority: [name: "High"],
                    labels: ["jenkins", "automated", "build-failure"]
                ]
            ]
            
            def response = httpRequest(
                url: "https://danielmaz.atlassian.net/rest/api/3/issue",
                httpMode: 'POST',
                contentType: 'APPLICATION_JSON',
                requestBody: groovy.json.JsonOutput.toJson(payload),
                authentication: 'jira-credentials',
                validResponseCodes: '201'
            )
            
            def json = readJSON text: response.content
            echo "Created JIRA issue: ${json.key}"
            return json.key
        }
    } catch (Exception e) {
        echo "Failed to create JIRA issue: ${e.message}"
        return null
    }
}

def createJiraSuccessIssue() {
    try {
        withCredentials([usernamePassword(
            credentialsId: 'jira-credentials',
            usernameVariable: 'JIRA_USER',
            passwordVariable: 'JIRA_TOKEN'
        )]) {
            def summary = "Build Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            
            // Build test status strings
            def e2eStatus = params.RUN_E2E_TESTS ? "Passed" : "Skipped"
            def perfStatus = params.RUN_PERFORMANCE_TESTS ? "Passed" : "Skipped"
            def stagingStatus = params.DEPLOY_TO_STAGING ? "Deployed" : "Skipped"
            def prodStatus = params.DEPLOY_TO_PRODUCTION ? "Deployed" : "Skipped"
            
            // JIRA API v3 requires ADF (Atlassian Document Format) for description
            def payload = [
                fields: [
                    project: [key: JIRA_PROJECT_KEY],
                    summary: summary,
                    description: [
                        type: "doc",
                        version: 1,
                        content: [
                            [
                                type: "heading",
                                attrs: [level: 2],
                                content: [[type: "text", text: "Build Success Summary"]]
                            ],
                            [
                                type: "paragraph",
                                content: [[type: "text", text: "The CI/CD pipeline completed successfully!"]]
                            ],
                            [
                                type: "heading",
                                attrs: [level: 3],
                                content: [[type: "text", text: "Build Details"]]
                            ],
                            [
                                type: "bulletList",
                                content: [
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Job: ${env.JOB_NAME}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Build: #${env.BUILD_NUMBER}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Version: ${VERSION_TAG}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Duration: ${currentBuild.durationString ?: 'N/A'}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Build URL: ${env.BUILD_URL}"]]]]]
                                ]
                            ],
                            [
                                type: "heading",
                                attrs: [level: 3],
                                content: [[type: "text", text: "Tests Executed"]]
                            ],
                            [
                                type: "bulletList",
                                content: [
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Unit Tests: Passed"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Integration Tests: Passed"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "E2E Tests: ${e2eStatus}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Performance Tests: ${perfStatus}"]]]]]
                                ]
                            ],
                            [
                                type: "heading",
                                attrs: [level: 3],
                                content: [[type: "text", text: "Deployment Status"]]
                            ],
                            [
                                type: "bulletList",
                                content: [
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Staging: ${stagingStatus}"]]]]],
                                    [type: "listItem", content: [[type: "paragraph", content: [[type: "text", text: "Production: ${prodStatus}"]]]]]
                                ]
                            ]
                        ]
                    ],
                    issuetype: [name: "Task"],
                    priority: [name: "Low"],
                    labels: ["jenkins", "automated", "build-success", "ci-cd"]
                ]
            ]
            
            def response = httpRequest(
                url: "https://danielmaz.atlassian.net/rest/api/3/issue",
                httpMode: 'POST',
                contentType: 'APPLICATION_JSON',
                requestBody: groovy.json.JsonOutput.toJson(payload),
                authentication: 'jira-credentials',
                validResponseCodes: '201'
            )
            
            def json = readJSON text: response.content
            echo "Created JIRA success issue: ${json.key}"
            return json.key
        }
    } catch (Exception e) {
        echo "Failed to create JIRA success issue: ${e.message}"
        return null
    }
}
